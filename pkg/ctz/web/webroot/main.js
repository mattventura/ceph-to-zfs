(()=>{"use strict";var e={5:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Chooser=void 0,t.Chooser=class{callback;values;selection;prevSel;kvMap;valueElementMap;fullElement;headerArea;chooserArea;_hasInitialData=!1;constructor(e,t){this.callback=t,this.selection=null,this.prevSel=null,this.values=[],this.valueElementMap=new Map,this.kvMap=new Map,this.fullElement=document.createElement("div"),this.fullElement.classList.add("chooser"),this.chooserArea=document.createElement("div"),this.chooserArea.classList.add("content-area"),this.headerArea=document.createElement("div"),this.headerArea.classList.add("header-area"),this.headerArea.replaceChildren(...e),this.fullElement.replaceChildren(this.headerArea,this.chooserArea)}makeItemUi(e){const t=this.makeListItemUi(),s=this;return t.element.classList.add("chooser-item"),t.element.addEventListener("click",(t=>{s.setSelectionByKey(e)})),t}get allValues(){return[...this.values]}setSelectionByKey(e,t=!0){if(null===e)this.setSelection(null,t);else{const s=this.kvMap.get(e);void 0===s?this.setSelection(null,t):this.setSelection({item:s,key:e},t)}}setSelection(e,t=!0){this.selection=e,this.refreshSelection(t)}set allValues(e){if(e.length>0){if(!this._hasInitialData){const t=e[0];this.selection={item:t,key:this.extractKey(t)}}this._hasInitialData=!0}this.values=[...e];const t=this.valueElementMap,s=new Map,a=new Map,l=[];let i=!1;for(const n of e){const e=this.extractKey(n);a.set(e,n);let r=t.get(e);void 0===r&&(r=this.makeItemUi(e),i=!0),r.formatFor(e,n),s.set(e,r),l.push(r.element)}if(null!==this.selection){const t=this.selection.key;void 0===s.get(t)&&(this.selection=null);const a=e.find((e=>this.extractKey(e)===t));this.selection=void 0===a?null:{item:a,key:t}}this.valueElementMap=s,this.kvMap=a,this.refreshSelection(!1),(i||t.size!==s.size)&&this.chooserArea.replaceChildren(...l)}refreshSelection(e){const t=this.prevSel,s=this.selection;let a=!1;try{a=this.callback({new:s,old:t},e)}catch(e){console.error(e)}a?(this.valueElementMap.forEach(((e,t)=>{e.setSelected(t===s?.key)})),this.prevSel=s):this.selection=t}get hasInitialData(){return this._hasInitialData}get selectedItem(){return this.selection}}},557:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fmtUnix=function(e){return new Date(1e3*e).toLocaleString()},t.fmtDur=function(e){const t=e%60,s=Math.floor(e/3600),a=Math.floor(e%3600/60);return 0===s?0===a?t.toFixed(3):`${a}:${t.toFixed(3)}`:`${s}:${a}:${t.toFixed(3)}`},t.fmtBytes=function(e){return e>i?`${(e/i).toFixed(3)} TiB`:e>l?`${(e/l).toFixed(3)} GiB`:e>a?`${(e/a).toFixed(1)} MiB`:e>s?`${(e/s).toFixed(0)} KiB`:`${e} B`};const s=1024,a=1024*s,l=1024*a,i=1024*l},878:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.el=function(e,t){const s=document.createElement(e);return t&&(t.classes&&s.classList.add(...t.classes),t.children&&s.replaceChildren(...t.children)),s},t.addStatusLabelClasses=function(e,t){e.classList.add("status-label"),e.classList.remove("terminal-failed","terminal-success","in-progress","not-started"),t.isTerminal?t.isBad?e.classList.add("terminal-failed"):e.classList.add("terminal-success"):t.isActive?e.classList.add("in-progress"):e.classList.add("not-started")},t.arraysEqual=function(e,t){if(null===e&&null===t)return!0;if(null===e||null===t)return!1;if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}}},t={};function s(a){var l=t[a];if(void 0!==l)return l.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,s),i.exports}(()=>{const e=s(5),t=s(878),a=s(557);class l{_ele;leftLabel;rightLabel;_prevLabel=null;_prevStatusType=null;constructor(){this._ele=document.createElement("div"),this.leftLabel=(0,t.el)("span"),this.rightLabel=(0,t.el)("span");const e=(0,t.el)("div",{classes:["left-area"],children:[this.leftLabel]}),s=(0,t.el)("div",{classes:["right-area"],children:[this.rightLabel]});this._ele.replaceChildren(e,s),this._ele.classList.add("chooser-item-bisected")}get element(){return this._ele}formatFor(e,s){this._prevLabel!==s.label&&(this.leftLabel.textContent=s.label,this.leftLabel.title=s.label,this._prevLabel=s.label);const a=s.status;this._prevStatusType!==a.type&&((0,t.addStatusLabelClasses)(this.rightLabel,a),this._prevStatusType=a.type,this.rightLabel.textContent=a.type)}setSelected(e){e?this._ele.classList.add("selected"):this._ele.classList.remove("selected")}}class i extends e.Chooser{extractKey(e){return e.id}makeListItemUi(){return new l}}class n{fullArea;headerArea;contentArea;detailsTable;snapshotsTable;snapshotsTableBody;lastJobPath=null;constructor(){this.detailsTable=(0,t.el)("table",{classes:["job-detail-table","extra-detail-table-area"]}),this.snapshotsTable=(0,t.el)("table",{classes:["job-detail-table","snapshots-detail-table"]}),this.snapshotsTableBody=this.snapshotsTable.createTBody(),this.snapshotsTable.createTHead().replaceChildren((0,t.el)("tr",{children:["Snapshot","Source","Receiver"].map((e=>(0,t.el)("th",{children:[e]})))})),this.snapshotsTable.style.display="none",this.headerArea=(0,t.el)("div",{classes:["header-area"]}),this.contentArea=(0,t.el)("div",{classes:["content-area"]}),this.fullArea=(0,t.el)("div",{classes:["detail-display"],children:[this.headerArea,this.contentArea]})}setContent(e){if(null===e){this.headerArea.textContent="Job Status";const e=(0,t.el)("span");return e.textContent="No job selected",void this.contentArea.replaceChildren(e)}(0,t.arraysEqual)(e.path,this.lastJobPath)||(e.label!==e.id?this.headerArea.textContent=`${e.label} (${e.id})`:this.headerArea.textContent=e.label,this.snapshotsTable.style.display="none",this.lastJobPath=e.path),Object.keys(e.extraData).length>0?(function(e,s){const l=[];function i(e,a,i){const n=s[e];void 0!==n&&l.push((0,t.el)("tr",{children:[(0,t.el)("td",{children:[a]}),(0,t.el)("td",{children:[i(n)]})]}))}i("snapName","Snapshot Name",(e=>e)),i("cron","Cron",(e=>e)),i("bytesWritten","Bytes Written",a.fmtBytes),i("bytesTrimmed","Bytes Trimmed",a.fmtBytes),i("prepStartTime","Prep Start",a.fmtUnix),i("prepEndTime","Prep End",a.fmtUnix),i("prepTime","Prep Time",a.fmtDur),i("runStartTime","Run Start",a.fmtUnix),i("runEndTime","Run End",a.fmtUnix),i("runTime","Run Time",a.fmtDur),e.replaceChildren(...l)}(this.detailsTable,e.extraData),this.detailsTable.style.display=""):this.detailsTable.style.display="none";const s=(0,t.el)("span"),l=e.status;s.innerText=l.type+": ",(0,t.addStatusLabelClasses)(s,l);const i=(0,t.el)("span");i.innerText=l.message,this.contentArea.replaceChildren(s,i,this.detailsTable,this.snapshotsTable);const n=e.path.join("/");fetch(h(`/api/taskdetails/${n}`)).then((e=>e.json())).then((s=>{if(!(0,t.arraysEqual)(e.path,this.lastJobPath))return;const a=s.detailData.snapshotReport,l=[];void 0!==a?(a.snapshots.forEach((e=>{const s=(0,t.el)("td",{children:[e.name]}),a=r(e.source),i=r(e.receiver);l.push((0,t.el)("tr",{children:[s,a,i]}))})),this.snapshotsTableBody.replaceChildren(...l),this.snapshotsTable.style.display=""):this.snapshotsTable.style.display="none"})).catch((e=>console.error("error getting task details",e)))}}function r(e){return null===e?(0,t.el)("td",{children:["Absent"],classes:["snapshot-absent"]}):e.pruned?(0,t.el)("td",{children:["Pruned"],classes:["snapshot-pruned"]}):(0,t.el)("td",{children:["Kept"],classes:["snapshot-kept"]})}const o=function(){const e=localStorage.getItem("apiServerOverride");if(null!==e)try{return new URL(e)}catch(t){console.error(`Invalid override: '${e}'`)}return new URL(document.location.href)}();function h(e){return new URL(e,o)}function c(e,t,s){const a=document.createElement("button");return a.textContent=e,a.addEventListener("click",t),s&&(a.title=s),a}class d{element;timeDisplay;constructor(e){const s=document.createElement("div");s.classList.add("toolbar");const a=c("Refresh",e),l=c("Run All",(()=>fetch(h("/api/startall"))));this.timeDisplay=(0,t.el)("span"),this.timeDisplay.classList.add("time-display"),this.timeDisplay.textContent="Connecting...";const i=(0,t.el)("div",{classes:["toolbar-left"],children:[a,l]}),n=(0,t.el)("div",{classes:["toolbar-mid-spacer"]}),r=(0,t.el)("div",{classes:["toolbar-right"],children:[this.timeDisplay]});s.replaceChildren(i,n,r),this.element=s}setTimestamp(e){this.timeDisplay.textContent=(0,a.fmtUnix)(e)}}class u{mainTable;jobChooser;imageChooser;taskDetailHolder;toolbar;outer;constructor(){const e=document.createElement("div");e.classList.add("main-table"),this.mainTable=e;const t=new n;this.taskDetailHolder=t.fullArea,this.imageChooser=new i(["Images"],(e=>{const s=e.new?.item;return void 0!==s&&t.setContent(s),!0})),this.jobChooser=new i(["Jobs"],((e,s)=>{const a=e.new?.item;return this.imageChooser.allValues=a?.children??[],s?(this.imageChooser.setSelection(null,!1),t.setContent(a??null)):0===this.jobChooser.allValues.length?t.setContent(null):void 0!==a&&null===this.imageChooser.selectedItem&&t.setContent(a),!0})),e.replaceChildren(this.jobChooser.fullElement,this.imageChooser.fullElement,this.taskDetailHolder),this.toolbar=new d((()=>this.refresh())),this.outer=document.createElement("div"),this.outer.classList.add("main-page"),this.outer.replaceChildren(this.toolbar.element,this.mainTable)}get mainElement(){return this.outer}async refresh(){const e=new URL("/api/alltasks",o),t=await fetch(e).then((e=>e.json())),s=t.task,a={...s,path:[],children:s.children.map((e=>m(e,[])))};this.setTimeStamp(t.serverInfo.unixTime),this.jobChooser.allValues=a.children}setTimeStamp(e){this.toolbar.setTimestamp(e)}}function m(e,t){const s=[...t,e.id];return{...e,path:s,children:e.children.map((e=>m(e,s)))}}document.addEventListener("DOMContentLoaded",(()=>{const e=new u;document.querySelector("body")?.append(e.mainElement),window.mainUI=e,async function t(){try{window.pause||await e.refresh()}catch(e){console.error("Error refreshing",e)}finally{setTimeout(t,1e3)}}()}))})()})();